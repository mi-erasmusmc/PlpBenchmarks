#' View a shiny app with the benchmark results
#'
#' @details
#' Upload the results to a database, create a shiny app and view it.
#' @param benchmarkDesign A list of class `benchmarkDesign` as generated by \code{createBenchmarkDesign()}.
#' @param cohortDefinitions An object of class `cohortDefinitionSet` as provided by \code{CohortGenerator::getCohortDefinitionSet()}
#' @param databaseList A list containing the database names.
#' @param createPlpResultTables A logical to indicate whether to create the PlpResults tables. Defaults to `TRUE` and this will delete the tables (if they exist) and re-create them.
#' @param viewShiny Whether to view the shiny app or not, defaults to `TRUE`.
#' @param databaseDirectory Directory to save the generated database with the results.
#'
#' @return
#' NULL
#'
#' @export
viewBenchmarkResults <- function(benchmarkDesign = NULL,
                                    cohortDefinitions = NULL,
                                    databaseList,
                                    createPlpResultTables = TRUE,
                                    viewShiny = TRUE,
                                    databaseDirectory = NULL) {
  
  viewPlpShiny <- checkmate::makeAssertCollection()
  
  checkmate::assert(
    checkmate::checkList(benchmarkDesign, types = "modelDesign", null.ok = FALSE, names = "named"),
    checkmate::checkClass(benchmarkDesign, classes = "benchmarkDesign", null.ok = FALSE),
    combine = "and",
    add = viewPlpShiny
  )
  
  checkmate::assertCharacter(databaseDirectory, 
                             add = viewPlpShiny)
  
  checkmate::reportAssertions(viewPlpShiny)
  
  if (basename(databaseDirectory) == "sqlite" && dir.exists(dirname(databaseDirectory))) {
    sqliteLocation <- databaseDirectory
  } else {
    sqliteLocation <- file.path(databaseDirectory, "sqlite")
  }

  if (!dir.exists(sqliteLocation)) {
    dir.create(sqliteLocation, recursive = T)
  }

  connectionDetails <- DatabaseConnector::createConnectionDetails(
    dbms = "sqlite",
    server = file.path(sqliteLocation, "databaseFile.sqlite")
  )

  if (createPlpResultTables) {
    PatientLevelPrediction::createPlpResultTables(
      connectionDetails = connectionDetails,
      targetDialect = "sqlite",
      resultSchema = "main",
      deleteTables = T,
      createTables = T,
      tablePrefix = ""
    )
  }

  resultLocationVector <- file.path(sapply(benchmarkDesign, "[[", "saveDirectory"), "plpResult")

  PatientLevelPrediction:::addMultipleRunPlpToDatabase(
    connectionDetails = connectionDetails,
    cohortDefinitions = cohortDefinitions,
    databaseList = databaseList,
    resultLocationVector = resultLocationVector,
    modelSaveLocation = file.path(sqliteLocation)
  )

  ParallelLogger::logInfo(paste("Database with results created at", sqliteLocation))
  if (viewShiny) {
    PatientLevelPrediction::viewDatabaseResultPlp(
      mySchema = "main",
      myServer = connectionDetails$server(),
      myUser = NULL,
      myPassword = NULL,
      myDbms = "sqlite",
      myPort = NULL,
      myTableAppend = ""
    )
  }

  return(invisible())
}
