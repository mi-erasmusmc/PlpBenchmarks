#' View a shiny app with the benchmark results
#' 
#' @details
#' Upload the results to a database, create a shiny app and view it.
#' @param resultLocation File path to the folder storing the results to upload. 
#' @param benchmarkDesign A list of class `benchmarkDesign` as generated by \code{createBenchmarkDesign()}.
#' @param cohortDefinitions An object of class `cohortDefinitionSet` as provided by \code{CohortGenerator::getCohortDefinitionSet()} 
#' @param databaseList A list containing the database names. 
#' @param createPlpResultTables A logical to indicate whether to create the PlpResults tables. Defaults to `TRUE` and this will delete the tables (if they exist) and re-create them. 
#' @param viewShiny Whether to view the shiny app or not, defaults to `TRUE`.
#' @param sqliteLocation Directory to save cohort counts and/or which cohorts have been generated. 
#'
#' @return
#' NULL
#'
#' @export
viewBenchmarkPlpResults <- function(resultLocation, 
                                    benchmarkDesign, 
                                    cohortDefinitions = NULL,
                                    databaseList, 
                                    createPlpResultTables = TRUE, 
                                    viewShiny = TRUE, 
                                    sqliteLocation = NULL){
  
  if (is.null(sqliteLocation)){
    sqliteLocation = file.path(resultLocation, 'sqlite')
  } else {
    sqliteLocation = file.path.(sqliteLocation, 'sqlite')
  }
  
  if(!dir.exists(sqliteLocation)){
    dir.create(sqliteLocation, recursive = T)
  }
  
  connectionDetails <- DatabaseConnector::createConnectionDetails(
    dbms = 'sqlite',
    server = file.path(sqliteLocation,'databaseFile.sqlite')
  )
  
  if (createPlpResultTables) {
    PatientLevelPrediction::createPlpResultTables(
      connectionDetails = connectionDetails,
      targetDialect = 'sqlite',
      resultSchema = 'main', 
      deleteTables = T, 
      createTables = T,
      tablePrefix = ''
    )
  }
  
  resultLocationVector = file.path(sapply(benchmarkDesign, "[[", "saveDirectory"), "plpResult")
  
  PatientLevelPrediction::addMultipleRunPlpToDatabase(connectionDetails = connectionDetails, 
                                                      cohortDefinitions = cohortDefinitions, 
                                                      databaseList = databaseList, 
                                                      resultLocationVector = resultLocationVector, 
                                                      modelSaveLocation = file.path(sqliteLocation))
  
  if (viewShiny){
    PatientLevelPrediction::viewDatabaseResultPlp(mySchema = "main",
                                                  myServer = connectionDetails$server(),
                                                  myUser = NULL, 
                                                  myPassword = NULL,
                                                  myDbms = "sqlite",
                                                  myPort = NULL, 
                                                  myTableAppend ='')}
  
  return(invisible())
}